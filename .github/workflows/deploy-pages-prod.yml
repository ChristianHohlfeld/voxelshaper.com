name: Build & publish (deploy-from-branch + SEO)

on:
  push:
    branches: ["main"]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-and-publish:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Prepare dist
        run: |
          set -e
          rm -rf dist && mkdir -p dist
          cp index.html dist/index.html
          # cp -R assets dist/assets || true
          touch dist/.nojekyll

      - name: SEO inject (canonical, OG/Twitter, JSON-LD, etc.)
        run: |
          set -euo pipefail
          cd dist

          # Domain bestimmen (CNAME aus Repo-Root, sonst Fallback)
          DOMAIN="$(cat ../CNAME 2>/dev/null || true)"
          if [ -z "${DOMAIN:-}" ]; then
            echo "::warning::No CNAME in repo root. Falling back to owner.github.io"
            DOMAIN="${GITHUB_REPOSITORY_OWNER}.github.io"
          fi
          echo "$DOMAIN" > CNAME

          CANON="https://${DOMAIN}/"
          OG="${CANON}og.png"
          LOGO="${CANON}logo-512.png"

          # Texte je Domain
          if [[ "$DOMAIN" == "hub.voxelshaper.com" ]]; then
            TITLE="VoxelShaper Hub – 3D-Modelle & Community für Maker"
            DESC="Teile, stöbere und lade 3D-druckbare Voxel-Modelle. Bambu-Studio-freundliche 3MF/STL-Assets. Minecraft-Style Block-CAD."
            KEYS="voxel models, 3mf, stl, bambu studio, makerworld, voxel cad, block cad, minecraft style, community, download"
          else
            TITLE="VoxelShaper – Voxel-CAD für 3D-Druck (Bambu Lab Ready)"
            DESC="Einfaches voxel-basiertes CAD für Maker. Minecraft-Style Modelle, Export als 3MF/STL für Bambu Studio & AMS Multicolor."
            KEYS="voxel cad, voxel editor, block based cad, 3d printing cad, bambu lab, 3mf export, stl export, ams multicolor, maker cad, minecraft style 3d editor"
          fi

          # Alte Head-Tags entfernen
          perl -0777 -i -pe '
            s~<meta[^>]+property="og:[^"]+"[^>]*>~~gi;
            s~<meta[^>]+name="twitter:[^"]+"[^>]*>~~gi;
            s~<meta[^>]+name="description"[^>]*>~~gi;
            s~<meta[^>]+name="keywords"[^>]*>~~gi;
            s~<link[^>]+rel=["\x27]canonical["\x27][^>]*>~~gi;
            s~<script[^>]+application/ld\+json[^>]*>.*?</script>~~gsi;
          ' index.html

          # JSON-LD bauen (einzeilig)
          JSONLD='{"@context":"https://schema.org","@graph":[{"@type":"Organization","@id":"https://voxelshaper.com/#org","name":"VoxelShaper","url":"https://voxelshaper.com/","logo":"'"$LOGO"'","sameAs":[]},{"@type":"WebApplication","@id":"'"$CANON"'#app","name":"VoxelShaper","url":"'"$CANON"'","applicationCategory":"DesignApplication","operatingSystem":"Web","isAccessibleForFree":true},{"@type":"WebSite","@id":"'"$CANON"'#website","name":"VoxelShaper","url":"'"$CANON"'"}]}'

          # SEO-Block in Datei schreiben (eine Zeile)
          printf '<meta name="description" content="%s"><meta name="keywords" content="%s"><link rel="canonical" href="%s"><meta property="og:title" content="%s"><meta property="og:description" content="%s"><meta property="og:type" content="website"><meta property="og:url" content="%s"><meta property="og:image" content="%s"><meta property="og:site_name" content="VoxelShaper"><meta name="twitter:card" content="summary_large_image"><meta name="twitter:title" content="%s"><meta name="twitter:description" content="%s"><meta name="twitter:image" content="%s"><script type="application/ld+json">%s</script>' \
            "$DESC" "$KEYS" "$CANON" "$TITLE" "$DESC" "$CANON" "$OG" "$TITLE" "$DESC" "$OG" "$JSONLD" > __seo.html

          # Sicher vor </head> einsetzen (liest Datei; keine @-Interpolation)
          perl -0777 -i -pe 'BEGIN{ open my $fh,"<","__seo.html" or die $!; local $/; our $SEO=<$fh>; } s{</head>}{$SEO</head>}i' index.html
          rm -f __seo.html

          # robots.txt + sitemap.xml
          printf "User-agent: *\nDisallow:\nSitemap: %ssitemap.xml\n" "$CANON" > robots.txt
          NOW=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          printf '%s\n' '<?xml version="1.0" encoding="UTF-8"?>' \
            '<urlset xmlns="http://www.sitemaps.org/schemas/sitemap/0.9">' \
            "  <url><loc>${CANON}</loc><lastmod>${NOW}</lastmod><changefreq>weekly</changefreq><priority>1.0</priority></url>" \
            '</urlset>' > sitemap.xml

      - name: One-line HTML (optional GH quirk workaround)
        run: |
          set -e
          cd dist
          tr '\n' ' ' < index.html > __1l && mv __1l index.html

      - name: Deploy to branch "pages"
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./dist
          publish_branch: pages
          # cname: hub.voxelshaper.com   # optional
          # force_orphan: true           # optional
