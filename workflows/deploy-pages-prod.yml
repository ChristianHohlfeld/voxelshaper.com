name: Deploy static content to Pages (prod + SEO)

on:
  push:
    branches: ["main"]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Pages
        uses: actions/configure-pages@v5

      - name: Prepare output folder
        run: |
          set -e
          rm -rf out
          mkdir -p out
          # Kopiere deine statischen Dateien ins Deploy-Verzeichnis
          shopt -s dotglob
          cp -R ./* out/
          # Pages braucht keine Jekyll-Verarbeitung
          touch out/.nojekyll

      - name: üîß SEO inject (canonical, OG/Twitter, JSON-LD, robots.txt, sitemap.xml)
        run: |
          set -euo pipefail
          cd out

          DOMAIN="$(cat ../CNAME 2>/dev/null || echo "${GITHUB_REPOSITORY_OWNER}.github.io")"
          CANONICAL="https://${DOMAIN}/"

          # --- projektspezifische Texte (App vs Hub) ---
          if [[ "$DOMAIN" == "hub.voxelshaper.com" ]]; then
            TITLE="VoxelShaper Hub ‚Äì 3D-Modelle & Community f√ºr Maker"
            DESC="Teile, st√∂bere und lade 3D-druckbare Voxel-Modelle. Bambu-Studio-freundliche 3MF/STL-Assets. Minecraft-Style Block-CAD."
            KEYWORDS="voxel models, 3mf, stl, bambu studio, makerworld, voxel cad, block cad, minecraft style, community, download"
          else
            TITLE="VoxelShaper ‚Äì Voxel-CAD f√ºr 3D-Druck (Bambu Lab Ready)"
            DESC="Schnelles, einfaches voxel-basiertes CAD f√ºr Maker. Baue Minecraft-Style Modelle und exportiere 3MF/STL f√ºr Bambu Studio & AMS Multicolor."
            KEYWORDS="voxel cad, voxel editor, block based cad, 3d printing cad, bambu lab, 3mf export, stl export, ams multicolor, maker cad, minecraft style 3d editor"
          fi

          # OG/Logo Bilder (leg die Dateien ins Repo-Root)
          OG_IMAGE="${CANONICAL}og.png"
          LOGO="${CANONICAL}logo-512.png"

          # Stelle sicher, dass index.html existiert
          test -f index.html || { echo "::error::index.html not found in out/"; exit 1; }

          # Alte Tags entfernen (auch deine alten test.* OGs)
          perl -0777 -i -pe '
            s~<meta[^>]+property="og:[^"]+"[^>]*>~~gi;
            s~<meta[^>]+name="twitter:[^"]+"[^>]*>~~gi;
            s~<meta[^>]+name="description"[^>]*>~~gi;
            s~<meta[^>]+name="keywords"[^>]*>~~gi;
            s~<link[^>]+rel=["\x27]canonical["\x27][^>]*>~~gi;
            s~<script[^>]+application/ld\+json[^>]*>.*?</script>~~gsi;
          ' index.html

          # SEO-Block zusammenbauen (absolute canonical-URL, wie von Google empfohlen)
          # https://developers.google.com/search/docs/crawling-indexing/consolidate-duplicate-urls
          read -r -d '' SEO_BLOCK <<'EOF'
<meta name="description" content="__DESC__">
<!-- (Meta keywords werden von Google ignoriert, schaden aber nicht) -->
<meta name="keywords" content="__KEYS__">
<link rel="canonical" href="__CANON__">
<!-- Open Graph (https://ogp.me/) -->
<meta property="og:title" content="__TITLE__">
<meta property="og:description" content="__DESC__">
<meta property="og:type" content="website">
<meta property="og:url" content="__CANON__">
<meta property="og:image" content="__OG__">
<meta property="og:site_name" content="VoxelShaper">
<meta property="og:locale" content="de_DE">
<meta property="og:locale:alternate" content="en_US">
<!-- Twitter Cards (Summary Large Image) -->
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:title" content="__TITLE__">
<meta name="twitter:description" content="__DESC__">
<meta name="twitter:image" content="__OG__">
<!-- Structured Data: Organization + WebApplication + WebSite (JSON-LD) -->
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@graph": [
    {
      "@type": "Organization",
      "@id": "https://voxelshaper.com/#org",
      "name": "VoxelShaper",
      "url": "https://voxelshaper.com/",
      "logo": "__LOGO__",
      "sameAs": []
    },
    {
      "@type": "WebApplication",
      "@id": "__CANON__#app",
      "name": "VoxelShaper",
      "url": "__CANON__",
      "applicationCategory": "DesignApplication",
      "operatingSystem": "Web",
      "isAccessibleForFree": true
    },
    {
      "@type": "WebSite",
      "@id": "__CANON__#website",
      "name": "VoxelShaper",
      "url": "__CANON__"
    }
  ]
}
</script>
EOF
          SEO_BLOCK="${SEO_BLOCK//__TITLE__/$TITLE}"
          SEO_BLOCK="${SEO_BLOCK//__DESC__/$DESC}"
          SEO_BLOCK="${SEO_BLOCK//__KEYS__/$KEYWORDS}"
          SEO_BLOCK="${SEO_BLOCK//__CANON__/$CANONICAL}"
          SEO_BLOCK="${SEO_BLOCK//__OG__/$OG_IMAGE}"
          SEO_BLOCK="${SEO_BLOCK//__LOGO__/$LOGO}"

          perl -0777 -i -pe "s~</head>~${SEO_BLOCK//~/\\~}\n</head>~i" index.html

          # robots.txt (Allow + Sitemap) und sitemap.xml
          printf "User-agent: *\nDisallow:\nSitemap: %ssitemap.xml\n" "$CANONICAL" > robots.txt

          NOW=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          cat > sitemap.xml <<XML
<?xml version="1.0" encoding="UTF-8"?>
<urlset xmlns="http://www.sitemaps.org/schemas/sitemap/0.9">
  <url><loc>${CANONICAL}</loc><lastmod>${NOW}</lastmod><changefreq>weekly</changefreq><priority>0.8</priority></url>
</urlset>
XML

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: 'out'  # GitHub Pages erwartet hier deine fertigen Files
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
